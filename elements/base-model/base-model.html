<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="base-model" attributes="storageId pk">

    <script>
        (function () {
            Polymer('base-model', {
                storage: null,
                defaultData: {
                    id: null,
                    created: null,
                    modified: null,
                    name: ''
                },
                data: {},
                fields: {},
                validators: {},

                computed: {
                    'isNew': '!pk'
                },

                pkChanged: function() {
                    this.refresh();
                },

                storageIdChanged: function (oldValue, newValue) {
                    this.storage = document.querySelector('#' + newValue);
                },

                save: function () {
                    var self = this,
                        ret;
                    if (this.isNew) {
                        ret = this.storage.post(self.data);
                        ret.then(function () {
                            self.data = JSON.parse(JSON.stringify(self.defaultData));
                        });
                    } else {
                        ret = this.storage.put(self.data);
                        ret.then(function (data) {
                            self.data = data;
                        });
                    }

                    return ret;
                },

                delete: function () {
                    return this.storage.delete(parseInt(this.pk || this.data.id, 10));
                },

                refresh: function () {
                    if (this.isNew) {
                        this.data = JSON.parse(JSON.stringify(this.defaultData));
                    } else {
                        this.async(function() {
                            var ret = this.storage.get(parseInt(this.pk || this.data.id, 10));
                            var self = this;
                            ret.then(function (data) {
                                self.data = data;
                            });

                            return ret;
                        });
                    }

                }

            });
        })();
    </script>
</polymer-element>
