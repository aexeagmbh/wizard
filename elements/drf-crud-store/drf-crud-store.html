<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../drf-crud/drf-crud.html">
<link rel="import" href="../app-globals/app-globals.html">


<polymer-element name="drf-crud-store" attributes="singleEndPoint listEndPoint verboseSingleName verbosePluralName notifierId">
    <template>
        <app-globals id="globals"></app-globals>
        <drf-crud id="drfCrud" listUrl="{{listUrl}}" postUrl="{{postUrl}}" getUrl="{{getUrl}}" putUrl="{{putUrl}}"
                  deleteUrl="{{deleteUrl}}"></drf-crud>
    </template>
    <script>
        (function () {


            Polymer('drf-crud-store', {

                objectList: [],

                listEndPoint: null,
                singleEndPoint: null,

                listUrl: null,
                postUrl: null,
                getUrl: null,
                putUrl: null,
                deleteUrl: null,

                computed: {
                    listEndPointUrl: '$.globals.values.apiUrl + "/" + listEndPoint + "/"',
                    singleEndPointUrl: '$.globals.values.apiUrl + "/" + singleEndPoint + "/"'
                },

                items: [],

                itemKeys: [],

                _setItems: function (items) {
                    var self = this;
                    self.items = items;
                },

                _setItem: function (item) {
                    var itemIdx = this._getItemIdx(item.id);
                    if (itemIdx !== undefined) {
                        this.items[itemIdx] = item;
                    } else {
                        this.items.append(item);
                    }
                },

                _getItemIdx: function (id) {
                    var retIdx;
                    this.items.forEach(function (item, idx) {
                       if (item.id === id) {
                           retIdx = idx;
                           return false;
                       }
                    });
                    return retIdx;

                },

                _getItem: function (id) {
                      var ret = this.items.filter(function (item, idx) {
                         return item.id === id;
                      }) || [];
                      return ret[0];
                },

                _deleteItem: function (id) {
                    var itemIdx = this._getItemIdx(id);
                    this.items.splice(itemIdx, 1);
                },



                list: function () {
                    var self = this,
                        p = new Promise(function (resolve, reject) {
                            var crud = self.$.drfCrud,
                                res;
                            crud.listUrl = self.listEndPointUrl;

                            res = crud.promiseList({});
                            res.then(function (response) {
                                self._setItems(response.response);
                                resolve(self.items);
                            }).catch(function (e) {
                                reject(e);
                            });
                        });
                    p.then(function (payload) {

                    });
                    p.catch(function (e) {
                         document.querySelector('#' + self.notifierId).notify('ERROR: Loading ' + self.verbosePluralName + ' failed');
                    });
                    return p;
                },
                get: function (pk) {
                    var self = this,
                        p = new Promise(function (resolve, reject) {
                            var crud = self.$.drfCrud,
                                item = self._getItem(pk),
                                res;
                            crud.getUrl = self.singleEndPointUrl + pk + "/";

                            if (item) {
                                resolve(item);
                            } else {

                                res = crud.promiseGet({});
                                res.then(function (response) {
                                    self._setItem(response.response);
                                    resolve(self._getItem(pk));
                                }).catch(function (e) {
                                    reject(e);
                                });
                            }
                        });
                    p.then(function (payload) {

                    });
                    p.catch(function (e) {
                         document.querySelector('#' + self.notifierId).notify('ERROR: Loading ' + self.verboseSingleName + ' failed');
                    });
                    return p;
                },
                post: function (data) {
                    var self = this,
                        p = new Promise(function (resolve, reject) {
                            var crud = self.$.drfCrud,
                                res;
                            crud.postUrl = self.singleEndPointUrl;

                            res = crud.promisePost({}, data);
                            res.then(function (payload) {
                                resolve(payload.response);
                            }).catch(function (e) {
                                reject(e);
                            });
                        });
                    p.then(function (payload) {

                    });
                    p.catch(function (e) {
                         document.querySelector('#' + self.notifierId).notify('ERROR: Creating ' + self.verboseSingleName + ' failed');
                    });
                    return p;
                },
                put: function (data, id) {
                    var self = this,
                        pk = data.id || id,
                        p = new Promise(function (resolve, reject) {
                            var crud = self.$.drfCrud,
                                res;
                            crud.putUrl = self.singleEndPointUrl + pk + "/";

                            res = crud.promisePut({}, data);
                            res.then(function (payload) {
                                resolve(payload.response);
                            }).catch(function (e) {
                                reject(e);
                            });
                        });
                    p.then(function (payload) {

                    });
                    p.catch(function (e) {
                         document.querySelector('#' + self.notifierId).notify('ERROR: Saving ' + self.verboseSingleName + ' failed');
                    });
                    return p;
                },
                delete: function (pk) {
                    var self = this,
                        p = new Promise(function (resolve, reject) {
                            var crud = self.$.drfCrud,
                                res;
                            crud.deleteUrl = self.singleEndPointUrl + pk + "/";

                            res = crud.promiseDelete({});
                            res.then(function (payload) {
                                console.log({'delete': self.items});
                                self._deleteItem(pk);

                                resolve(payload);
                            }).catch(function (e) {
                                reject(e);
                            });
                        });
                    p.then(function (payload) {

                    });
                    p.catch(function (e) {
                         document.querySelector('#' + self.notifierId).notify('ERROR: Deleting ' + self.verboseSingleName + ' failed');
                    });
                    return p;
                }
            });
        })();
    </script>
</polymer-element>
