<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../drf-crud/drf-crud.html">
<!--<link rel="import" href="../../bower_components/baasic-crud/baasic-crud.html">-->
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-action-dialog.html">

<polymer-element name="model-training" attributes="pk">
    <template>
        <drf-crud id="crudElement"
            geturl="{{baseUrl}}/{{version}}/trainings/{{pk}}/"
            posturl="{{baseUrl}}/{{version}}/trainings/"
            puturl="{{baseUrl}}/{{version}}/trainings/{{pk}}/"
            deleteurl="{{baseUrl}}/{{version}}/trainings/{{pk}}/"
            on-get-completed="{{handleCrudCompleted}}"
            on-get-error="{{handleCrudError}}"></drf-crud>
        <div class="training">
            <h2>{{data.name}}</h2>
        <div horizontal layout center>
            <paper-input label="Name" floatingLabel="true" value="{{data.name}}"></paper-input>
            <paper-icon-button icon="delete" on-click="{{confirmDeleteAction}}"></paper-icon-button>
            <paper-action-dialog id="confirmDialog" heading="Delete training?">
                <p>Do you really want to delete the training "{{data.name}}"?</p>
                <paper-button dismissive>Cancel</paper-button>
                <paper-button affirmative on-click="{{deleteAction}}">Confirm</paper-button>
            </paper-action-dialog>
        </div>
        </div>
    </template>
    <script>
        (function () {
            Polymer('model-training', {
                baseUrl: 'http://localhost:8001/api',
                version: 'v1',
                data: {},
                dataChanged: function(oldValue, newValue){

                    console.log({dataChanged: arguments});
                    if(oldValue && Object.keys(oldValue).length) {
                        clearTimeout(this.dataChangeTimeout);
                        this.dataChangeTimeout = window.setTimeout(this.updateAPI.bind(this), 500);
                    }
                },
                updateAPI: function() {
                    console.log('Saving to API');
                    this.$.crudElement.put({}, JSON.stringify(this.data));
                    document.querySelector('#userNotifier').notify('Training saved');
                },
                observe: {
                    'data.name': 'dataChanged'
                },
                confirmDeleteAction: function() {
                    this.$.confirmDialog.open();
                },
                deleteAction: function() {
                    this.$.crudElement.delete({});
                },
                domReady: function() {
                    return this.refresh();
                },
                refresh: function() {
                    return this.$.crudElement.get({});
                },
                handleCrudCompleted: function(e, response, element) {
                    this.data = response.response;
                },
                handleCrudError: function(response) {
                    document.querySelector('#userNotifier').notify('Error comminucating with API: ' + response);
                }
            });
        })();
    </script>
</polymer-element>
