<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../drf-crud/drf-crud.html">
<!--<link rel="import" href="../../bower_components/baasic-crud/baasic-crud.html">-->
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-action-dialog.html">

<polymer-element name="model-training" attributes="training storageId">
    <template>
        <div class="training">
            <h2>{{training.name}}</h2>
        <div horizontal layout center>
            <paper-input label="Name" floatingLabel="true" value="{{training.name}}"></paper-input>
            <paper-icon-button icon="delete" on-click="{{confirmDeleteAction}}"></paper-icon-button>
            <paper-action-dialog id="confirmDialog" heading="Delete training?">
                <p>Do you really want to delete the training "{{training.name}}"?</p>
                <paper-button dismissive>Cancel</paper-button>
                <paper-button affirmative on-click="{{deleteAction}}">Confirm</paper-button>
            </paper-action-dialog>
        </div>
        </div>
    </template>
    <script>
        (function () {
            Polymer('model-training', {
                storage: null,
                storageIdChanged: function (oldValue, newValue) {
                  this.storage = document.querySelector('#' + newValue);
                },

                trainingChanged: function(oldValue, newValue){
                    console.log({dataChanged: arguments});
                    if(oldValue && Object.keys(oldValue).length) {
                        clearTimeout(this.dataChangeTimeout);
                        this.dataChangeTimeout = window.setTimeout(this.updateAPI.bind(this), 500);
                    }
                },
                updateAPI: function() {
                    console.log('Saving to API');
                    this.storage.put(JSON.stringify(this.training), this.training.id);
                    document.querySelector('#userNotifier').notify('Training saved');
                },
                observe: {
                    'training.name': 'trainingChanged'
                },
                confirmDeleteAction: function() {
                    this.$.confirmDialog.open();
                },
                deleteAction: function() {
                    console.log();
                    this.storage.delete(this.training.id);
                },
                domReady: function() {
                    return this.refresh();
                },
                refresh: function() {
                    var model = this;

                    this.asyncMethod(function() {
                        console.log({model: model});
                        var id = model.training ? model.training.id : pk;
                        model.storage.get(model.training.id || model.pk).then(function (response) {
                            model.training = response;
                        }).catch(function (e) {

                        });
                    });
                }
                // handleCrudCompleted: function(e, response, element) {
                //     this.data = response.response;
                // },
                // handleCrudError: function(response) {
                //     document.querySelector('#userNotifier').notify('Error comminucating with API: ' + response);
                // }
            });
        })();
    </script>
</polymer-element>
